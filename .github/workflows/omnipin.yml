name: Deploy with Omnipin

on:
  # Allow for manual triggering
  workflow_dispatch:
  # Automatically trigger at 9:30am UTC on the 1st of each month
  schedule:
    - cron: '30 9 1 * *'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install bun
        uses: oven-sh/setup-bun@v2

      - name: Install Omnipin
        run: bun add -g omnipin@2.0.3

      - name: Build website
        run: bun install && bun run build

      - name: Deploy the site
        run: omnipin deploy src/dist \
          --strict \
          --ens ${{ vars.OMNIPIN_ENS }} \
          --safe ${{ vars.OMNIPIN_SAFE }}
        env:
          # Storacha for uploads
          OMNIPIN_STORACHA_TOKEN: ${{ secrets.OMNIPIN_STORACHA_TOKEN }}
          OMNIPIN_STORACHA_PROOF: ${{ secrets.OMNIPIN_STORACHA_PROOF }}

          # Filecoin for uploads
          OMNIPIN_FILECOIN_TOKEN: ${{ secrets.OMNIPIN_FILECOIN_TOKEN }}

          # Lighthouse for pinning
          OMNIPIN_LIGHTHOUSE_TOKEN: ${{ secrets.OMNIPIN_LIGHTHOUSE_TOKEN }}

          # Wallet that proposes transactions to the Safe
          OMNIPIN_PK: ${{ secrets.OMNIPIN_PK }}
