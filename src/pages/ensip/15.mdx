{/** @type {import('@/lib/mdxPageProps').MdxMetaProps} */}
export const meta = {
    description: '',
    contributors: [
        // Andrew Raffensperger
        'adraffy'
    ],
    ensip: {
        status: 'draft',
        created: '2023-04-03',
        updated: '2024-09-14',
    }
};

# ENSIP-15: ENS Name Normalization Standard

## Abstract

This ENSIP standardizes Ethereum Name Service (ENS) name normalization process outlined in [ENSIP-1 ¬ß Name Syntax](./1#name-syntax).

## Motivation

* Since [ENSIP-1](./1) (originally [EIP-137](https://eips.ethereum.org/EIPS/eip-137)) was finalized in 2016, Unicode has [evolved](https://unicode.org/history/publicationdates.html) from version 8.0.0 to 15.0.0 and incorporated many new characters, including complex emoji sequences. 
* ENSIP-1 does not state the version of Unicode.
* ENSIP-1 implies but does not state an explicit flavor of IDNA processing. 
* [UTS-46](https://unicode.org/reports/tr46/) is insufficient to normalize emoji sequences. Correct emoji processing is only possible with [UTS-51](https://www.unicode.org/reports/tr51/).
* Validation tests are needed to ensure implementation compliance.
* The success of ENS has encouraged spoofing via the following techniques:
	1. Insertion of zero-width characters.
	1. Using names which normalize differently between algorithms. 
	1. Using names which appear differently between applications and devices.
	1. Substitution of confusable (look-alike) characters.
	1. Mixing incompatible scripts.

## Specification

* Unicode version `16.0.0`
	* Normalization is a living specification and should use the latest stable version of Unicode.
* [`spec.json`](https://github.com/adraffy/ens-normalize.js/blob/main/derive/output/spec.json) contains all [necessary data](#description-of-specjson) for normalization.
* [`nf.json`](https://github.com/adraffy/ens-normalize.js/blob/main/derive/output/nf.json) contains all [necessary data](#description-of-nfjson) for [Unicode Normalization Forms](https://unicode.org/reports/tr15/) NFC and NFD.

### Definitions

* Terms in **bold** throughout this document correspond with [components of `spec.json`](#description-of-specjson).
* A string is a sequence of Unicode codepoints.
	* Example: `"abc"` is `61 62 63`
* An [Unicode emoji](https://www.unicode.org/reports/tr51/) is a [single entity](https://unicode.org/reports/tr29/#Grapheme_Cluster_Boundaries) composed of one or more codepoints:
	* An **Emoji Sequence** is the preferred form of an emoji, resulting from input that [tokenized](#tokenize) into an `Emoji` token.
		* Example: `üí©Ô∏éÔ∏é [1F4A9]` ‚Üí `Emoji[1F4A9 FE0F]`
			* `1F4A9 FE0F` is the **Emoji Sequence**.
	* [`spec.json`](#description-of-specjson) contains the complete [list of valid](./ensip-15/emoji.md) **Emoji Sequences**.		
		* [Derivation](#derivation) defines which emoji are normalizable.
		* Not all Unicode emoji are valid.
			* `‚Äº [203C] double exclamation mark` ‚Üí *error: Disallowed character*
			* `üàÅ [1F201] Japanese ‚Äúhere‚Äù button` ‚Üí `Text["„Ç≥„Ç≥"]`
	* An **Emoji Sequence** may contain characters that are disallowed:
		* `üë©‚Äç‚ù§Ô∏è‚Äçüë® [1F469 200D 2764 FE0F 200D 1F468] couple with heart: woman, man` ‚Äî contains ZWJ
		* `#Ô∏è‚É£ [23 FE0F 20E3] keycap: #` ‚Äî contains `23 (#)`
		* `üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø [1F3F4 E0067 E0062 E0065 E006E E0067 E007F]` ‚Äî contains `E00XX`
	* An **Emoji Sequence** may contain other emoji:
		* Example: `‚ù§Ô∏è [2764 FE0F] red heart` is a substring of `‚ù§Ô∏è‚Äçüî• [2764 FE0F 200D 1F525] heart on fire` 
	* Single-codepoint emoji may have various [presentation styles](https://www.unicode.org/reports/tr51/#Presentation_Style) on input:
		* Default: `‚ù§ [2764]`
		* Text: `‚ù§Ô∏é [2764 FE0E]`
		* Emoji: `‚ù§Ô∏è [2764 FE0F]`
	* However, these all [tokenize](#tokenize) to the same **Emoji Sequence**.
	* All **Emoji Sequence** have explicit emoji-presentation.
	* The convention of ignoring presentation is difficult to change because:
		* Presentation characters (`FE0F` and `FE0E`) are **Ignored**
	 	* [ENSIP-1](./1) did not treat emoji differently from text
		* Registration hashes are immutable
	* [Beautification](#annex-beautification) can be used to restore emoji-presentation in normalized names.
	
### Algorithm

* Normalization is the process of canonicalizing a name before for [hashing](./1#namehash-algorithm).
* It is idempotent: applying normalization multiple times produces the same result.
* For user convenience, leading and trailing whitespace should be trimmed before normalization, as all whitespace codepoints are disallowed.  Inner characters should remain unmodified.
* No string transformations (like case-folding) should be applied.

1. [Split](#split) the name into [labels](./1#name-syntax).
1. [Normalize](#normalize) each label.
1. [Join](#join) the labels together into a name again.

### Normalize

1. [Tokenize](#tokenize) ‚Äî transform the label into `Text` and `Emoji` tokens.
	* If there are no tokens, the label cannot be normalized.
1. Apply [NFC](https://unicode.org/reports/tr15/#Norm_Forms) to each `Text` token.
	* Example: `Text["aÃÄ"]` ‚Üí `[61 300] ‚Üí [E0]` ‚Üí `Text["√†"]`
1. Strip `FE0F` from each `Emoji` token.
1. [Validate](#validate) ‚Äî check if the tokens are valid and obtain the **Label Type**.
	* The **Label Type** and **Restricted** state may be presented to user for additional security.
1. Concatenate the tokens together.
	* Return the normalized label.

Examples:

1. `"_$A" [5F 24 41]` ‚Üí `"_$a" [5F 24 61]` ‚Äî *ASCII*
1. `"EÔ∏éÃÉ" [45 FE0E 303]` ‚Üí `"·∫Ω" [1EBD]` ‚Äî *Latin*
1. `"ìÜèüê∏" [1318F 1F438]` ‚Üí `"ìÜèüê∏" [1318F 1F438]` ‚Äî *Restricted: Egyp*
1. `"nƒ±Ãáck" [6E 131 307 63 6B]` ‚Üí *error: Disallowed character*

### Tokenize

Convert a label into a list of `Text` and `Emoji` tokens, each with a payload of codepoints.  The complete list of character types and [emoji sequences](#appendix-additional-resources) can be found in [`spec.json`](#description-of-specjson).  

1. Allocate an empty codepoint buffer.
1. Find the longest **Emoji Sequence** that matches the remaining input.
	* Example: `üë®üèª‚Äçüíª [1F468 1F3FB 200D 1F4BB]`
		* Match (1): `üë®Ô∏è [1F468] man` 
		* Match (2): `üë®üèª [1F468 1F3FB] man: light skin tone`
		* Match (4): `üë®üèª‚Äçüíª [1F468 1F3FB 200D 1F4BB] man technologist: light skin tone` ‚Äî longest match!
	* `FE0F` is optional from the input during matching.
		* Example: `üë®‚Äç‚ù§Ô∏è‚Äçüë® [1F468 200D 2764 FE0F 200D 1F468]`
			* Match: `1F468 200D 2764 FE0F 200D 1F468` ‚Äî fully-qualified
			* Match: `1F468 200D 2764 200D 1F468` ‚Äî missing `FE0F`
			* No match: `1F468 FE0F 200D 2764 FE0F 200D 1F468` ‚Äî extra `FE0F`
			* No match: `1F468 200D 2764 FE0F FE0F 200D 1F468` ‚Äî has (2) `FE0F`
	* This is equivalent to `/^(emoji1|emoji2|...)/` where `\uFE0F` is replaced with `\uFE0F?` and `*` is replaced with `\x2A`.
1. If an **Emoji Sequence** is found:
	* If the buffer is nonempty, emit a `Text` token, and clear the buffer.
	* Emit an `Emoji` token with the fully-qualified matching sequence.
	* Remove the matched sequence from the input.
1. Otherwise:
	1. Remove the leading codepoint from the input.
	1. Determine the character type:
		* If **Valid**, append the codepoint to the buffer.
			* This set can be precomputed from the union of characters in all groups and their NFD decompositions.
		* If **Mapped**, append the corresponding mapped codepoint(s) to the buffer.
		* If **Ignored**, do nothing.
		* Otherwise, the label cannot be normalized.
1. Repeat until all the input is consumed.
1. If the buffer is nonempty, emit a final `Text` token with its contents.
	* Return the list of emitted tokens.

Examples:

1. `"xyzüë®üèª" [78 79 7A 1F468 1F3FB]` ‚Üí `Text["xyz"]` + `Emoji["üë®üèª"]`
1. `"Aüí©Ô∏éÔ∏éb" [41 FE0E 1F4A9 FE0E FE0E 62]` ‚Üí `Text["a"]` + `Emoji["üí©Ô∏è"]` + `Text["b"]`
1. `"a‚Ñ¢Ô∏è" [61 2122 FE0F]` ‚Üí `Text["atm"]`

### Validate

Given a list of `Emoji` and `Text` tokens, determine if the label is valid and return the **Label Type**.  If any assertion fails, the name cannot be normalized.

1. If only `Emoji` tokens:
	* Return `"Emoji"`
1. If a single `Text` token and every characters is ASCII (`00..7F`):
	* `5F (_) LOW LINE` can only occur at the start.
		* Must match `/^_*[^_]*$/`
		* Examples: `"___"` and `"__abc"` are valid, `"abc__"` and `"_abc_"` are invalid.
	* The 3rd and 4th characters must not both be `2D (-) HYPHEN-MINUS`.
		* Must not match `/^..--/`
		* Examples: `"ab-c"` and `"---a"`are valid, `"xn--"` and `----` are invalid.
	* Return `"ASCII"`
		* The label is free of **Fenced** and **Combining Mark** characters, and not confusable.
1. Concatenate all the tokens together.
	* `5F (_) LOW LINE` can only occur at the start.
	* The first and last characters cannot be **Fenced**.
		* Examples: `"a‚Äôs"` and `"a„Éªa"` are valid, `"‚Äô85"` and `"joneses‚Äô"` and `"„Éªa„Éª"` are invalid.
	* **Fenced** characters cannot be contiguous.
		* Examples: `"a„Éªa‚Äôs"` is valid, `"6‚Äô0‚Äô‚Äô"` and `"a„Éª„Éªa"` are invalid.
1. The first character of every `Text` token must not be a **Combining Mark**.
1. Concatenate the `Text` tokens together.
1. Find the first **Group** that contain every text character:
	* If no group is found, the label cannot be normalized.
1. If the group is not **CM Whitelisted**:
	* Apply NFD to the concatenated text characters.
	* For every contiguous sequence of **NSM** characters:
		* Each character must be unique.
			* Example: `"xÃÄÃÄ" [78 300 300]` has (2) grave accents.
		* The number of **NSM** characters cannot exceed **Maximum NSM** (4).
			* Example: ` "ÿßŸïÿêÿëÿíÿìÿî"‚Äé [625 610 611 612 613 614]` has (6) **NSM**.
1. [Wholes](#wholes) ‚Äî check if text characters form a confusable.
1. The label is valid.
	* Return the name of the group as the **Label Type**.

Examples:

1. `Emoji["üí©Ô∏è"]` + `Emoji["üí©Ô∏è"]` ‚Üí `"Emoji"`
1. `Text["abc$123"]` ‚Üí `"ASCII"`
1. `Emoji["üöÄÔ∏è"]` + `Text["√†"]` ‚Üí `"Latin"`

### Wholes

A label is [whole-script confusable](https://unicode.org/reports/tr39/#def_whole_script_confusables) if a similarly-looking valid label can be constructed using one alternative character from a different group.  The complete list of **Whole Confusables** can be found in [`spec.json`](#description-of-specjson).  Each **Whole Confusable** has a set of non-confusing characters (`"valid"`) and a set of confusing characters (`"confused"`) where each character may be the member of one or more groups.

Example: **Whole Confusable** for `"g"`

| Type | Code | Form | Character  | Latn | Hani | Japn | Kore | Armn | Cher | Lisu |
| :-: | -: | :-: | :- | :-: | :-: | :-: | :-: | :-: | :-: | :-: |
| valid | `67` | `g` | LATIN SMALL LETTER G | A | A | A | A |
| confused | `581` | `÷Å` | ARMENIAN SMALL LETTER CO  | | | | | B | 
| confused | `13C0` | `·èÄ` | CHEROKEE LETTER NAH  | | | | | | C | 
| confused | `13F3` | `·è≥` | CHEROKEE LETTER YU  |	| | | | | C |
| confused |  `A4D6` | `Íìñ` | LISU LETTER GA | | | | | | | D |

1. Allocate an empty character buffer.
1. Start with the set of **ALL** groups.
1. For each unique character in the label:
	* If the character is **Confused** (a member of a **Whole Confusable**):
		* Retain groups with **Whole Confusable** characters excluding the **Confusable Extent** of the matching **Confused** character.
		* If no groups remain, the label is not confusable.
		* The **Confusable Extent** is the fully-connected graph formed from different groups with the same confusable and different confusables of the same group.
			* The mapping from **Confused** to **Confusable Extent** can be precomputed.
		* In the table above, **Whole Confusable** for `"g"`, the rectangle formed by each capital letter is a **Confusable Extent**:
			* `A` is [`g`] ‚äó [*Latin*, *Han*, *Japanese*, *Korean*]
			* `B` is [`÷Å`] ‚äó [*Armn*]
			* `C` is [`·èÄ`, `·è≥`] ‚äó [*Cher*]
			* `D` is [`Íìñ`] ‚äó [*Lisu*]
		* A **Confusable Extent** can span multiple characters and multiple groups.  Consider the (incomplete) **Whole Confusable** for `"o"`:
			* `6F (o) LATIN SMALL LETTER O` ‚Üí *Latin*, *Han*, *Japanese*, and *Korean*
			* `3007 („Äá) IDEOGRAPHIC NUMBER ZERO` ‚Üí *Han*, *Japanese*, *Korean*, and *Bopomofo*
			* **Confusable Extent** is [`o`, `„Äá`] ‚äó [*Latin*, *Han*, *Japanese*, *Korean*, *Bopomofo*]
	* If the character is **Unique**, the label is not confusable.
		* This set can be precomputed from characters that appear in exactly one group and are not **Confused**.
	* Otherwise:
		* Append the character to the buffer.
1. If any **Confused** characters were found:
	* If there are no buffered characters, the label is confusable.
	* If any of the remaining groups contain all of the buffered characters, the label is confusable.
	* Example: `"0—Ö" [30 445]`
		1. `30 (0) DIGIT ZERO`
			* Not **Confused** or **Unique**, add to buffer.
		1. `445 (—Ö) CYRILLIC SMALL LETTER HA`
			* **Confusable Extent** is [`—Ö`, `4B3 (“≥) CYRILLIC SMALL LETTER HA WITH DESCENDER`] ‚äó [*Cyrillic*]
			* **Whole Confusable** excluding the extent is [`78 (x) LATIN SMALL LETTER X`, ...] ‚Üí [*Latin*, ...]
			* Remaining groups: **ALL** ‚à© [*Latin*, ...] ‚Üí [*Latin*, ...]
		1. There was (1) buffered character:
			* *Latin* also contains `30` ‚Üí `"0x" [30 78]`
		1. The label is confusable.
1. The label is not confusable.

A label composed of confusable characters isn't necessarily confusable.

* Example: `"—Ç”ï" [442 4D5]`
	1. `442 (—Ç) CYRILLIC SMALL LETTER TE` 
		* **Confusable Extent** is [`—Ç`] ‚äó [*Cyrillic*]
		* **Whole Confusable** excluding the extent is [`3C4 (œÑ) GREEK SMALL LETTER TAU`] ‚Üí [*Greek*]
		* Remaining groups: **ALL** ‚à© [*Greek*] ‚Üí [*Greek*]
	1. `4D5 (”ï) CYRILLIC SMALL LIGATURE A IE`
		* **Confusable Extent** is [`”ï`] ‚äó [*Greek*]
		* **Whole Confusable** excluding the extent is [`E6 (√¶) LATIN SMALL LETTER AE`] ‚Üí [*Latin*]
		* Remaining groups: [*Greek*] ‚à© [*Latin*] ‚Üí ‚àÖ
	1. No groups remain so the label is not confusable.

### Split

* Partition a name into labels, separated by `2D (.) FULL STOP`, and return the resulting array.
	* Example: `"abc.123.eth"` ‚Üí `["abc", "123", "eth"]`
* The empty string is 0-labels: `""` ‚Üí `[]`

### Join

* Assemble an array of labels into a name, inserting `2D (.) FULL STOP` between each label, and return the resulting string.
	* Example: `["abc", "123", "eth"]` ‚Üí `"abc.123.eth"`

## Description of `spec.json`

* **Groups** (`"groups"`) ‚Äî [groups](#appendix-additional-resources) of characters that can constitute a label
	* `"name"` ‚Äî ASCII name of the group (or abbreviation if **Restricted**)
		* Examples: *Latin*, *Japanese*, *Egyp*
	* **Restricted** (`"restricted"`) ‚Äî **`true`** if [Excluded](https://www.unicode.org/reports/tr31#Table_Candidate_Characters_for_Exclusion_from_Identifiers) or [Limited-Use](https://www.unicode.org/reports/tr31/#Table_Limited_Use_Scripts) script
		* Examples: *Latin* ‚Üí **`false`**, *Egyp* ‚Üí **`true`** 
	* `"primary"` ‚Äî subset of characters that define the group
		* Examples: `"a"` ‚Üí *Latin*, `"„ÅÇ"` ‚Üí *Japanese*, `"ìÄÄ"` ‚Üí *Egyp*
	* `"secondary"` ‚Äî subset of characters included with the group
		* Example: `"0"` ‚Üí *Common* but mixable with *Latin*
	* **CM Whitelist(ed)** (`"cm"`) ‚Äî (optional) set of allowed compound sequences in NFC
		* Each compound sequence is a character followed by one or more **Combining Marks**.
			* Example: `√†ÃÄÃÄ` ‚Üí `E0 300 300`
		* Currently, every group that is **CM Whitelist** has zero compound sequences.
		* **CM Whitelisted** is effectively **`true`** if `[]` otherwise **`false`**
* **Ignored** (`"ignored"`) ‚Äî [characters](#appendix-additional-resources) that are ignored during normalization
	* Example: `34F (ÔøΩ) COMBINING GRAPHEME JOINER`
* **Mapped** (`"mapped"`) ‚Äî characters that are mapped to a sequence of **valid** characters
	* Example: `41 (A) LATIN CAPITAL LETTER A` ‚Üí `[61 (a) LATIN SMALL LETTER A]`
	* Example: `2165 (‚Ö•) ROMAN NUMERAL SIX` ‚Üí `[76 (v) LATIN SMALL LETTER V, 69 (i) LATIN SMALL LETTER I]`
* **Whole Confusable** (`"wholes"`) ‚Äî groups of characters that look similar
	* `"valid"` ‚Äî subset of confusable characters that are allowed
		* Example: `34 (4) DIGIT FOUR`
	* **Confused** (`"confused"`) ‚Äî subset of confusable characters that confuse
		* Example: `13CE (·èé) CHEROKEE LETTER SE`
* **Fenced** (`"fenced"`) ‚Äî [characters](#appendix-additional-resources) that cannot be first, last, or contiguous
	* Example: `2044 (‚ÅÑ) FRACTION SLASH`
* **Emoji Sequence(s)** (`"emoji"`) ‚Äî valid [emoji sequences](#appendix-additional-resources)
	* Example: `üë®‚Äçüíª [1F468 200D 1F4BB] man technologist`
* **Combining Marks / CM** (`"cm"`) ‚Äî [characters](#appendix-additional-resources) that are [Combining Marks](https://unicode.org/faq/char_combmark.html)
* **Non-spacing Marks / NSM** (`"nsm"`) ‚Äî valid [subset](#appendix-additional-resources) of **CM** with general category (`"Mn"` or `"Me"`)
* **Maximum NSM** (`"nsm_max"`) ‚Äî maximum sequence length of unique **NSM**
* **Should Escape** (`"escape"`) ‚Äî [characters](#appendix-additional-resources) that shouldn't be printed
* **NFC Check** (`"nfc_check"`) ‚Äî valid [subset](#appendix-additional-resources) of characters that [may require NFC](https://unicode.org/reports/tr15/#NFC_QC_Optimization)

## Description of `nf.json`

* `"decomp"` ‚Äî [mapping](https://www.unicode.org/reports/tr44/tr44-30.html#Character_Decomposition_Mappings) from a composed character to a sequence of (partially)-decomposed characters
	* [`UnicodeData.txt`](https://www.unicode.org/reports/tr44/tr44-30.html#UnicodeData.txt) where `Decomposition_Mapping` exists and does not have a [formatting tag](https://www.unicode.org/reports/tr44/tr44-30.html#Formatting_Tags_Table)
* `"exclusions"` ‚Äî set of characters for which the `"decomp"` mapping is not applied when forming a composition
	* [`CompositionExclusions.txt`](https://www.unicode.org/reports/tr44/tr44-30.html#CompositionExclusions.txt)
* `"ranks"` ‚Äî sets of characters with increasing [`Canonical_Combining_Class`](https://www.unicode.org/reports/tr44/tr44-30.html#Canonical_Combining_Class_Values)
	* [`UnicodeData.txt`](https://www.unicode.org/reports/tr44/tr44-30.html#UnicodeData.txt) grouped by `Canonical_Combining_Class`
	* Class `0` is not included
* `"qc"` ‚Äî set of characters with property [`NFC_QC`](https://www.unicode.org/reports/tr44/tr44-30.html#Decompositions_and_Normalization) of value `N` or `M`
	* [`DerivedNormalizationProps.txt`](https://www.unicode.org/reports/tr44/tr44-30.html#DerivedNormalizationProps.txt)
	* **NFC Check** (from [`spec.json`](#description-of-specjson)) is a subset of this set

## Derivation

* [IDNA 2003](https://unicode.org/Public/idna/15.1.0/IdnaMappingTable.txt)
 	* `UseSTD3ASCIIRules` is **`true`**
	* `VerifyDnsLength` is **`false`**
	* `Transitional_Processing` is **`false`**
	* The following [deviations](https://unicode.org/reports/tr46/#Table_Deviation_Characters) are **valid**:
		* `DF (√ü) LATIN SMALL LETTER SHARP S`
		* `3C2 (œÇ) GREEK SMALL LETTER FINAL SIGMA`
	* `CheckHyphens` is **`false`** ([WHATWG URL Spec ¬ß 3.3](https://url.spec.whatwg.org/#idna))
	* `CheckBidi` is **`false`**
	* [ContextJ](https://datatracker.ietf.org/doc/html/rfc5892#appendix-A.1):
		* `200C (ÔøΩ) ZERO WIDTH NON-JOINER` (ZWNJ) is **disallowed everywhere**.
		* `200D (ÔøΩ) ZERO WIDTH JOINER` (ZWJ) is **only allowed** in emoji sequences.	
	* [ContextO](https://datatracker.ietf.org/doc/html/rfc5892#appendix-A.3): 
		* `B7 (¬∑) MIDDLE DOT` is **disallowed**.
		* `375 (Õµ) GREEK LOWER NUMERAL SIGN` is **disallowed**.
		* `5F3 (◊≥) HEBREW PUNCTUATION GERESH` and `5F4 (◊¥) HEBREW PUNCTUATION GERSHAYIM` are *Greek*.
		* `30FB („Éª) KATAKANA MIDDLE DOT` is **Fenced** and *Han*, *Japanese*, *Korean*, and *Bopomofo*. 
		* Some [Extended Arabic Numerals](https://en.wikipedia.org/wiki/Arabic_numerals) are **mapped**:
			* `6F0 (€∞)` ‚Üí `660 (Ÿ†) ARABIC-INDIC DIGIT ZERO`
			* `6F1 (€±)` ‚Üí `661 (Ÿ°) ARABIC-INDIC DIGIT ONE`
			* `6F2 (€≤)` ‚Üí `662 (Ÿ¢) ARABIC-INDIC DIGIT TWO`
			* `6F3 (€≥)` ‚Üí `663 (Ÿ£) ARABIC-INDIC DIGIT THREE`
			* `6F7 (€∑)` ‚Üí `667 (Ÿß) ARABIC-INDIC DIGIT SEVEN`
			* `6F8 (€∏)` ‚Üí `668 (Ÿ®) ARABIC-INDIC DIGIT EIGHT`
			* `6F9 (€π)` ‚Üí `669 (Ÿ©) ARABIC-INDIC DIGIT NINE`
* [Punycode](https://datatracker.ietf.org/doc/html/rfc3492) is not decoded.
* The following ASCII characters are **valid**:
	* `24 ($) DOLLAR SIGN`
	* `5F (_) LOW LINE` with [restrictions](#validate)
* Only label separator is `2E (.) FULL STOP`
	* No character maps to this character.
	* This simplifies name detection in unstructured text.
	* The following alternatives are **disallowed**:
		* `3002 („ÄÇ) IDEOGRAPHIC FULL STOP`
		* `FF0E (Ôºé) FULLWIDTH FULL STOP`
		* `FF61 (ÔΩ°) HALFWIDTH IDEOGRAPHIC FULL STOP`
* [Many characters](#appendix-additional-resources) are **disallowed** for various reasons:
	* Nearly all punctuation are **disallowed**.
		* Example: `589 (÷â) ARMENIAN FULL STOP`
	* All parentheses and brackets are **disallowed**.
		* Example: `2997 (‚¶ó) LEFT BLACK TORTOISE SHELL BRACKET`
	* Nearly all vocalization annotations are **disallowed**.
		* Example: `294 ( î) LATIN LETTER GLOTTAL STOP`
	* Obsolete, deprecated, and ancient characters are **disallowed**.
		* Example: `463 (—£) CYRILLIC SMALL LETTER YAT`
	* Combining, modifying, reversed, flipped, turned, and partial variations are **disallowed**.
		* Example: `218A (‚Üä) TURNED DIGIT TWO`
	* When multiple weights of the same character exist, the variant closest to "heavy" is selected and the rest **disallowed**.
		* Example: `üû°üû¢üû£üû§‚úöüû•üû¶üûß` ‚Üí `271A (‚úö) HEAVY GREEK CROSS`
		* This occasionally selects an emoji.
			* Example: ‚úîÔ∏è or `2714 (‚úîÔ∏é) HEAVY CHECK MARK` is selected instead of `2713 (‚úì) CHECK MARK`
	* Many visually confusable characters are **disallowed**.
		* Example: `131 (ƒ±) LATIN SMALL LETTER DOTLESS I`
	* Many ligatures, *n*-graphs, and *n*-grams are **disallowed.**
		* Example: `A74F (Íùè) LATIN SMALL LETTER OO`
	* Many esoteric characters are **disallowed**.
		* Example: `2376 (‚ç∂) APL FUNCTIONAL SYMBOL ALPHA UNDERBAR`
* Many hyphen-like characters are **mapped** to `2D (-) HYPHEN-MINUS`:
	* `2010 (‚Äê) HYPHEN`
	* `2011 (‚Äë) NON-BREAKING HYPHEN`
	* `2012 (‚Äí) FIGURE DASH`
	* `2013 (‚Äì) EN DASH`
	* `2014 (‚Äî) EM DASH`
	* `2015 (‚Äï) HORIZONTAL BAR`
	* `2043 (‚ÅÉ) HYPHEN BULLET`
	* `2212 (‚àí) MINUS SIGN`
	* `23AF (‚éØ) HORIZONTAL LINE EXTENSION`
	* `23E4 (‚è§) STRAIGHTNESS`
	* `FE58 (Ôπò) SMALL EM DASH`
	* `2E3A (‚∏∫) TWO-EM DASH` ‚Üí `"--"`
	* `2E3B (‚∏ª) THREE-EM DASH` ‚Üí `"---"`
* Characters are assigned to **Groups** according to [Unicode Script_Extensions](https://www.unicode.org/reports/tr24/#Script_Extensions_Def).
* **Groups** may contain [multiple scripts](#appendix-additional-resources):
	* Only *Latin*, *Greek*, *Cyrillic*, *Han*, *Japanese*, and *Korean* have access to *Common* characters.
	* *Latin*, *Greek*, *Cyrillic*, *Han*, *Japanese*, *Korean*, and *Bopomofo* only permit specific **Combining Mark** sequences.
	* *Han*, *Japanese*, and *Korean*  have access to `a-z`.
	* **Restricted** groups are always single-script.
	* [Unicode augmented script sets](https://www.unicode.org/reports/tr39/#Mixed_Script_Detection)
* Scripts *Braille*, *Linear A*, *Linear B*, and *Signwriting* are **disallowed**.
* `27 (') APOSTROPHE` is **mapped** to `2019 (‚Äô) RIGHT SINGLE QUOTATION MARK` for convenience.
* Ethereum symbol (`39E (Œû) GREEK CAPITAL LETTER XI`) is case-folded and *Common*.
* Emoji:
	* All emoji are [fully-qualified](https://www.unicode.org/reports/tr51/#def_fully_qualified_emoji).
	* Digits (`0-9`) are [not emoji](#appendix-additional-resources).
	* Emoji [mapped to non-emoji by IDNA](#appendix-additional-resources) cannot be used as emoji.
	* Emoji [disallowed by IDNA](#appendix-additional-resources) with default text-presentation are **disabled**:
		* `203C (‚ÄºÔ∏è) double exclamation mark`
		* `2049 (‚ÅâÔ∏è) exclamation question mark `
	* Remaining emoji characters are marked as **disallowed** (for text processing).
	* All `RGI_Emoji_ZWJ_Sequence` are **enabled**.
	* All `Emoji_Keycap_Sequence` are **enabled**.
	* All `RGI_Emoji_Tag_Sequence` are **enabled**.
	* All `RGI_Emoji_Modifier_Sequence` are **enabled**.
	* All `RGI_Emoji_Flag_Sequence` are **enabled**.
	* `Basic_Emoji` of the form `[X FE0F]` are **enabled**.
	* Emoji with default emoji-presentation are **enabled** as `[X FE0F]`.
	* Remaining single-character emoji are **enabled** as `[X FE0F]` (explicit emoji-presentation).
	* All singular Skin-color Modifiers are **disabled**.
	* All singular Regional Indicators are **disabled**.
	* Blacklisted emoji are **disabled**.
	* Whitelisted emoji are **enabled**.
* Confusables:
	* Nearly all [Unicode Confusables](https://www.unicode.org/Public/security/15.1.0/confusables.txt)
	* Emoji are not confusable.
	* ASCII confusables are case-folded.
		* Example: `61 (a) LATIN SMALL LETTER A` confuses with `13AA (·é™) CHEROKEE LETTER GO`

## Backwards Compatibility

* 99% of names are still valid.
* Preserves as much [Unicode IDNA](https://unicode.org/reports/tr46/) and [WHATWG URL](https://url.spec.whatwg.org/#idna) compatibility as possible.
* Only [valid emoji sequences](#appendix-additional-resources) are permitted.

## Security Considerations

* Unicode presentation may vary between applications and devices.
	* Unicode text is ultimately subject to font-styling and display context.		
	* Unsupported characters (`ÔøΩ`) may appear unremarkable.
	* Normalized single-character emoji sequences do not retain their explicit emoji-presentation and may display with [text or emoji](https://www.unicode.org/reports/tr51/#Presentation_Style) presentation styling.
		* `‚ù§Ô∏é` ‚Äî text-presentation and default-color
		* <span className="text-green-500">`‚ù§Ô∏é`</span> ‚Äî text-presentation and <span className="text-green-500">green</span>-color
		* <span className="text-green-500">`‚ù§Ô∏è`</span> ‚Äî emoji-presentation and <span className="text-green-500">green</span>-color
	* Unsupported emoji sequences with ZWJ may appear indistinguishable from those without ZWJ.
		* `üí©üí© [1F4A9 1F4A9]`
		* `üí©‚Äçüí© [1F4A9 200D 1F4A9]` ‚Üí *error: Disallowed character*
* Names composed of labels with varying bidi properties [may appear differently](https://discuss.ens.domains/t/bidi-label-ordering-spoof/15824) depending on context.
	* Normalization does not enforce single-directional names.
	* Names may be composed of labels of different directions but normalized labels are never bidirectional.
		* [LTR].[RTL] `bahrain.ŸÖÿµÿ±`  
		* [LTR+RTL] `bahrainŸÖÿµÿ±` ‚Üí *error: Illegal mixture: Latin + Arabic*
* Not all normalized names are visually unambiguous.
* This ENSIP only addresses **single-character** [confusables](https://www.unicode.org/reports/tr39/).
	* There exist confusable **multi-character** sequences:
		* `"‡Æ∂‡Øç‡Æ∞‡ØÄ" [BB6 BCD BB0 BC0]`
		* `"‡Æ∏‡Øç‡Æ∞‡ØÄ" [BB8 BCD BB0 BC0]`
	* There exist confusable emoji sequences: 
		* `üö¥ [1F6B4]` and `üö¥üèª [1F6B4 1F3FB]`
		* `üá∫üá∏ [1F1FA 1F1F8]` and `üá∫üá≤ [1F1FA 1F1F2]` 
		* `‚ô• [2665] BLACK HEART SUIT` and `‚ù§ [2764] HEAVY BLACK HEART`
		
## Copyright

Copyright and related rights waived via [CC0](https://creativecommons.org/publicdomain/zero/1.0/).

## Appendix: Reference Specifications

* [EIP-137: Ethereum Domain Name Service](https://eips.ethereum.org/EIPS/eip-137)
* [ENSIP-1: ENS](./1)
* [UAX-15: Normalization Forms](https://unicode.org/reports/tr15/)
* [UAX-24: Script Property](https://www.unicode.org/reports/tr24/)
* [UAX-29: Text Segmentation](https://unicode.org/reports/tr29/)
* [UAX-31: Identifier and Pattern Syntax](https://www.unicode.org/reports/tr31/)
* [UTS-39: Security Mechanisms](https://www.unicode.org/reports/tr39/)
* [UAX-44: Character Database](https://www.unicode.org/reports/tr44/)
* [UTS-46: IDNA Compatibility Processing](https://unicode.org/reports/tr46/)
* [UTS-51: Emoji](https://www.unicode.org/reports/tr51)
* [RFC-3492: Punycode](https://datatracker.ietf.org/doc/html/rfc3492)
* [RFC-5891: IDNA: Protocol](https://datatracker.ietf.org/doc/html/rfc5891) 
* [RFC-5892: The Unicode Code Points and IDNA](https://datatracker.ietf.org/doc/html/rfc5892)
* [Unicode CLDR](https://github.com/unicode-org/cldr)
* [WHATWG URL: IDNA](https://url.spec.whatwg.org/#idna)

## Appendix: Additional Resources

* [Supported Groups](https://github.com/adraffy/ens-normalize.js/blob/main/tools/ensip/groups.md)
* [Supported Emoji](https://github.com/adraffy/ens-normalize.js/blob/main/tools/ensip/emoji.md)
* [Additional Disallowed Characters](https://github.com/adraffy/ens-normalize.js/blob/main/tools/ensip/disallowed.csv)
* [Ignored Characters](https://github.com/adraffy/ens-normalize.js/blob/main/tools/ensip/ignored.csv)
* [Should Escape Characters ](https://github.com/adraffy/ens-normalize.js/blob/main/tools/ensip/escape.csv)
* [Combining Marks](https://github.com/adraffy/ens-normalize.js/blob/main/tools/ensip/cm.csv)
* [Non-spacing Marks](https://github.com/adraffy/ens-normalize.js/blob/main/tools/ensip/nsm.csv)
* [Fenced Characters](https://github.com/adraffy/ens-normalize.js/blob/main/tools/ensip/fenced.csv)
* [NFC Quick Check](https://github.com/adraffy/ens-normalize.js/blob/main/tools/ensip/nfc_check.csv)

## Appendix: Validation Tests

A list of [validation tests](https://github.com/adraffy/ens-normalize.js/blob/main/validate/tests.json) are provided with the following interpretation:

* Already Normalized: `{name: "a"}` ‚Üí `normalize("a")` is `"a"`
* Need Normalization: `{name: "A", norm: "a"}` ‚Üí `normalize("A")` is `"a"`
* Expect Error: `{name: "@", error: true}` ‚Üí `normalize("@")` throws

## Annex: Beautification

Follow [algorithm](#algorithm), except:

* Do not strip `FE0F` from `Emoji` tokens.
* Replace `3BE (Œæ) GREEK SMALL LETTER XI` with `39E (Œû) GREEK CAPITAL LETTER XI` if the label isn't *Greek*.
* Example: `normalize("‚ÄêŒû1Ô∏è‚É£") [2010 39E 31 FE0F 20E3]` is `"-Œæ1‚É£" [2D 3BE 31 20E3]`
* Example: `beautify("-Œæ1‚É£") [2D 3BE 31 20E3]"` is `"-Œû1Ô∏è‚É£" [2D 39E 31 FE0F 20E3]`
